<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Miner Admin Dashboard</title>

    <!-- CSS LIBRARIES -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <!-- SWEETALERT FOR POPUPS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --sol-green: #14F195;
            --sol-purple: #9945FF;
            --bg-dark: #090909;
            --card-bg: #141414;
            --border: rgba(255, 255, 255, 0.1);
            --font-main: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: #ffffff;
            font-family: var(--font-main);
            min-height: 100vh;
        }

        /* --- DASHBOARD UI --- */
        .sidebar {
            height: 100vh;
            background: #000;
            border-right: 1px solid var(--border);
            position: fixed;
            width: 250px;
            padding: 20px;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        
        .stat-card:hover { transform: translateY(-5px); border-color: var(--sol-purple); }

        .stat-val { font-size: 28px; font-weight: 900; color: white; }
        .stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .stat-icon { font-size: 40px; position: absolute; right: 20px; top: 20px; opacity: 0.2; }

        /* TABLE STYLES */
        .table-dark {
            background-color: transparent;
            --bs-table-bg: transparent;
        }
        .table-dark th {
            color: #888;
            font-weight: 500;
            border-bottom: 1px solid var(--border);
        }
        .table-dark td {
            color: #eee;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }
        .user-row:hover { background: rgba(255,255,255,0.02); }

        /* BADGES */
        .badge-rank { padding: 5px 10px; border-radius: 5px; font-size: 10px; font-weight: bold; }
        .rank-bronze { background: rgba(205, 127, 50, 0.2); color: #cd7f32; border: 1px solid #cd7f32; }
        .rank-silver { background: rgba(192, 192, 192, 0.2); color: #c0c0c0; border: 1px solid #c0c0c0; }
        .rank-gold { background: rgba(255, 215, 0, 0.2); color: #ffd700; border: 1px solid #ffd700; }
        .rank-plat { background: rgba(229, 228, 226, 0.2); color: #e5e4e2; border: 1px solid #e5e4e2; }

        /* REFERRAL LEADERBOARD */
        .ref-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .ref-count-badge {
            background: var(--sol-green); color: black; font-weight: bold;
            padding: 2px 8px; border-radius: 10px; font-size: 12px;
        }

        /* MODAL */
        .modal-content {
            background-color: #1a1a1a;
            border: 1px solid var(--sol-green);
            color: white;
        }
        .modal-header { border-bottom: 1px solid #333; }
        .modal-footer { border-top: 1px solid #333; }
        .detail-group { background: #111; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .detail-label { color: #888; font-size: 11px; }
        .detail-val { font-weight: bold; color: var(--sol-green); }

        /* SEARCH */
        .search-input {
            background: #111; border: 1px solid #333; color: white; padding: 10px 15px; border-radius: 30px; width: 300px;
        }
        .search-input:focus { background: #111; color: white; border-color: var(--sol-green); outline: none; }

        /* LOADING */
        #loader {
            position: fixed; inset: 0; background: black; z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333; border-top-color: var(--sol-green); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader"><div class="spinner"></div></div>

    <!-- SIDEBAR -->
    <div class="sidebar d-none d-md-block">
        <h4 class="mb-5" style="color: var(--sol-green); font-weight: 900;">
            <i class="ri-dashboard-3-fill"></i> ADMIN
        </h4>
        <div style="color: #666; font-size: 12px; margin-bottom: 10px;">MENU</div>
        <ul class="list-unstyled">
            <li class="mb-3"><a href="#" class="text-white text-decoration-none"><i class="ri-user-line me-2"></i> Users</a></li>
            <li class="mb-3"><a href="#" class="text-white-50 text-decoration-none"><i class="ri-settings-4-line me-2"></i> Settings</a></li>
        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <!-- TOP STATS -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="glass-card stat-card">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-val" id="total-users">0</div>
                    <i class="ri-group-fill stat-icon" style="color: var(--sol-purple);"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card stat-card">
                    <div class="stat-label">Total Coins</div>
                    <div class="stat-val" id="total-coins">0</div>
                    <i class="ri-coin-fill stat-icon" style="color: var(--sol-green);"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card stat-card">
                    <div class="stat-label">Total Referrals</div>
                    <div class="stat-val" id="total-refs">0</div>
                    <i class="ri-share-forward-fill stat-icon" style="color: orange;"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card stat-card">
                    <div class="stat-label">Avg. Bot Lvl</div>
                    <div class="stat-val" id="avg-bot">0</div>
                    <i class="ri-robot-2-fill stat-icon" style="color: cyan;"></i>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- MAIN USER TABLE -->
            <div class="col-lg-8">
                <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="m-0">User Database</h5>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search ID or Username..." onkeyup="filterTable()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="userTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Rank</th>
                                    <th>Refs</th> <!-- NEW COLUMN -->
                                    <th>Balance</th>
                                    <th>Energy</th>
                                    <th>Bot</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Data Injected Here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-data" class="text-center py-5 text-muted" style="display:none;">No users found matching query.</div>
                </div>
            </div>

            <!-- TOP REFERRERS LIST (NEW) -->
            <div class="col-lg-4">
                <div class="glass-card">
                    <h5 class="mb-4" style="color: gold;"><i class="ri-trophy-fill"></i> Top Referrers</h5>
                    <div id="top-ref-list">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- USER DETAIL MODAL -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">User Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="detail-group">
                                <div class="detail-label">USERNAME</div>
                                <div class="detail-val text-white" id="m-username">...</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="detail-group">
                                <div class="detail-label">USER ID</div>
                                <div class="detail-val text-white" id="m-id" style="font-size:10px;">...</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="detail-group">
                                <div class="detail-label">BALANCE</div>
                                <div class="detail-val" id="m-score" style="font-size: 18px;">0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="detail-group">
                                <div class="detail-label">REFERRALS</div>
                                <div class="detail-val text-warning" id="m-refcount">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label">TASKS COMPLETED</div>
                        <div class="detail-val text-white" id="m-tasks" style="font-weight: normal; font-size: 12px;">None</div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label">MAGIC AD CLAIMS</div>
                        <div class="detail-val text-white" id="m-ads" style="font-weight: normal; font-size: 11px; font-family: monospace;">
                            ...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteUser()">Delete User</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- YOUR PRIVATE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAghmBjfnclb4yIwEmx7Uxssj7cpZkea1Q",
            authDomain: "solanacoin-6d9a8.firebaseapp.com",
            databaseURL: "https://solanacoin-6d9a8-default-rtdb.firebaseio.com",
            projectId: "solanacoin-6d9a8",
            storageBucket: "solanacoin-6d9a8.firebasestorage.app",
            messagingSenderId: "269025348490",
            appId: "1:269025348490:web:87c95514a1d86485169673",
            measurementId: "G-00X84VW123"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let allUsers = [];
        let selectedUserId = null;

        // --- FETCH DATA ---
        async function loadData() {
            try {
                const snapshot = await get(ref(db, 'sol_users'));
                if (snapshot.exists()) {
                    allUsers = [];
                    let totalCoins = 0;
                    let totalBot = 0;
                    let totalReferrals = 0;

                    snapshot.forEach(child => {
                        const u = child.val();
                        u.key = child.key; // Store ID
                        
                        // Calculate Referrals
                        u.refCount = u.referrals ? Object.keys(u.referrals).length : 0;
                        
                        allUsers.push(u);
                        
                        totalCoins += (u.score || 0);
                        totalBot += (u.autoMiner || 0);
                        totalReferrals += u.refCount;
                    });

                    // Update Stats
                    document.getElementById('total-users').innerText = allUsers.length;
                    document.getElementById('total-coins').innerText = formatNum(totalCoins);
                    document.getElementById('total-refs').innerText = totalReferrals;
                    document.getElementById('avg-bot').innerText = (allUsers.length > 0 ? (totalBot / allUsers.length).toFixed(1) : 0);

                    // Sort by Score (Default)
                    allUsers.sort((a, b) => (b.score || 0) - (a.score || 0));

                    renderTable(allUsers);
                    renderTopReferrers(allUsers);
                }
            } catch (error) {
                console.error(error);
                Swal.fire("Error", "Failed to load database. Check Console.", "error");
            }
            document.getElementById('loader').style.display = 'none';
        }

        // --- RENDER MAIN TABLE ---
        window.renderTable = (data) => {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if(data.length === 0) {
                document.getElementById('no-data').style.display = 'block';
                return;
            }
            document.getElementById('no-data').style.display = 'none';

            data.forEach(u => {
                let rankBadge = '<span class="badge-rank rank-bronze">Bronze</span>';
                const s = u.score || 0;
                if(s > 100000) rankBadge = '<span class="badge-rank rank-plat">Platinum</span>';
                else if(s > 25000) rankBadge = '<span class="badge-rank rank-gold">Gold</span>';
                else if(s > 5000) rankBadge = '<span class="badge-rank rank-silver">Silver</span>';

                const tr = document.createElement('tr');
                tr.className = 'user-row';
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div style="width:30px; height:30px; background:#333; border-radius:50%; display:flex; justify-content:center; align-items:center; margin-right:10px; font-size:12px;">
                                <i class="ri-user-fill"></i>
                            </div>
                            <div>
                                <div style="font-weight:bold; font-size:14px;">${u.username || "Guest"}</div>
                                <div style="font-size:10px; color:#666;">${u.key}</div>
                            </div>
                        </div>
                    </td>
                    <td>${rankBadge}</td>
                    <td style="color:orange; font-weight:bold;">${u.refCount}</td>
                    <td style="color:var(--sol-green); font-weight:bold;">${formatNum(s)}</td>
                    <td>${u.energy || 0}/${u.maxEnergy || 50}</td>
                    <td><i class="ri-robot-2-line"></i> ${u.autoMiner || 0}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-light" onclick="viewUser('${u.key}')">View</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- RENDER TOP REFERRERS LIST ---
        function renderTopReferrers(users) {
            const listEl = document.getElementById('top-ref-list');
            listEl.innerHTML = '';

            // Sort by Referrals
            const sortedByRef = [...users].sort((a, b) => b.refCount - a.refCount).slice(0, 5);

            sortedByRef.forEach((u, index) => {
                if(u.refCount === 0) return; // Skip if 0 refs

                listEl.innerHTML += `
                <div class="ref-row">
                    <div class="d-flex align-items-center">
                        <div style="width:25px; margin-right:10px; color:gold; font-weight:bold;">#${index+1}</div>
                        <div>
                            <div style="font-weight:bold; font-size:14px;">${u.username || "Guest"}</div>
                            <div style="font-size:10px; color:#666;">${u.key.substring(0,8)}...</div>
                        </div>
                    </div>
                    <div class="ref-count-badge">${u.refCount} Refs</div>
                </div>`;
            });

            if(listEl.innerHTML === '') {
                listEl.innerHTML = '<div class="text-center text-muted py-3">No referrals yet.</div>';
            }
        }

        // --- FILTER ---
        window.filterTable = () => {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.username && u.username.toLowerCase().includes(q)) || 
                u.key.toLowerCase().includes(q)
            );
            renderTable(filtered);
        }

        // --- VIEW DETAIL LOGIC ---
        window.viewUser = (id) => {
            const u = allUsers.find(x => x.key === id);
            if(!u) return;

            selectedUserId = id;
            document.getElementById('m-username').innerText = u.username || "Guest";
            document.getElementById('m-id').innerText = u.key;
            document.getElementById('m-score').innerText = (u.score || 0).toLocaleString();
            document.getElementById('m-refcount').innerText = u.refCount;
            
            // Tasks
            if(u.completedTasks && Array.isArray(u.completedTasks) && u.completedTasks.length > 0) {
                document.getElementById('m-tasks').innerText = u.completedTasks.join(", ");
            } else {
                document.getElementById('m-tasks').innerText = "No tasks completed";
            }

            // Ads
            let adHtml = "";
            const claims = u.adClaims || [0,0,0,0];
            claims.forEach((ts, index) => {
                let timeStr = "Never";
                if(ts > 0) {
                    const d = new Date(ts);
                    timeStr = d.toLocaleTimeString();
                }
                adHtml += `Slot ${index+1}: <span style="color:#aaa">${timeStr}</span><br>`;
            });
            document.getElementById('m-ads').innerHTML = adHtml;

            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        }

        // --- DELETE USER ---
        window.deleteUser = async () => {
            if(!selectedUserId) return;
            
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                try {
                    await remove(ref(db, 'sol_users/' + selectedUserId));
                    Swal.fire('Deleted!', 'User has been removed.', 'success');
                    
                    // Close modal and reload
                    const modalEl = document.getElementById('detailModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    loadData();
                } catch (e) {
                    Swal.fire('Error', 'Could not delete user.', 'error');
                }
            }
        }

        function formatNum(n) {
            return Math.floor(n).toLocaleString();
        }

        // Initialize
        loadData();

        // Auto Refresh every 10 seconds
        setInterval(loadData, 10000);

    </script>

    <!-- BOOTSTRAP JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
